<%- include('./partials/header.ejs') %>

<div class="min-h-screen bg-gray-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-semibold text-gray-800">
                <%= user.name %>'s Cart
            </h1>
            <div class="flex gap-4">
                <a class="text-red-500 font-semibold cursor-pointer hover:text-red-600" href="#" id="showBill">Total Bill</a>
                <a class="text-blue-600 font-semibold cursor-pointer hover:text-blue-800" href="/profile">Go to Profile</a>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
            <% var sum = 0; %>
            <% user.cart.forEach(function(item) { %>
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="h-48 bg-yellow-100 flex items-center justify-center">
                        <img class="max-h-full max-w-full object-contain"
                            src="data:image/jpeg;base64,<%= item.image.toString('base64') %>"
                            alt="<%= item.name %>">
                    </div>
                    <div class="px-4 py-3 border-t border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 truncate">
                            <% if (item.name.length > 18) { %>
                                <%= item.name.slice(0, 18) + '...' %>
                            <% } else { %>
                                <%= item.name %>
                            <% } %>
                        </h2>
                        <a class="text-red-500 right-0" href="/delete/<%=item._id%>">Remove</a>
                        <div class="flex justify-between items-center mt-2">
                            <div class="price text-gray-700 text-[22px] font-semibold">₹ <%= item.price %>.00</div>
                            <div class="flex items-center gap-2">
                                <div class="add w-fit cursor-pointer rounded-sm h-fit bg-slate-200">
                                    <i class="w-7 h-7 flex items-center justify-center ri-add-line"></i>
                                </div>
                                <div class="quan px-2 py-1 rounded-md bg-white text-black">01</div>
                                <div class="subs w-fit cursor-pointer rounded-sm h-fit bg-slate-200">
                                    <i class="w-7 h-7 flex items-center justify-center ri-subtract-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2 text-sm text-gray-600">
                            <div class="discount text-black font-semibold">Discount : <span class="text-red-500">- <%= item.discount %>%
                                </span>
                            </div>
                            <div class="net text-black font-semibold">Net Amount: ₹ <%= (item.price - (item.price * (item.discount / 100))).toFixed(2) %>
                            </div>
                        </div>
                    </div>
                </div>
                <% sum += (item.price - (item.price * (item.discount / 100))); %>
            <% }); %>
        </div>

        <div class="absolute top-20 right-[16vw] bg-white rounded-lg shadow-lg p-4 hidden w-[20vw]" id="billSection">
            <h1 class="text-2xl font-semibold text-gray-800 mb-4">Your Bill</h1>
            <div class="flex justify-between items-center mb-2">
                <h5 class="text-gray-700">Total Amount :</h5>
                <h4 class="total">₹ <%= sum.toFixed(2) %>
                </h4>
            </div>
            <div class="flex justify-between items-center mb-2">
                <h5 class="text-gray-700">Shipping Charges :</h5>
                <h4>00</h4>
            </div>
            <div class="flex justify-between items-center mb-2">
                <h5 class="text-gray-700">Platform Charge :</h5>
                <h4>₹ 20</h4>
            </div>
            <div class="border-t border-gray-300 my-4"></div>
            <div class="flex justify-between items-center mt-2">
                <h5 class="text-[15px] font-semibold">Net Amount :</h5>
                <h4 class="finalNetAmount">₹ <%= (sum + 20).toFixed(2) %>
                </h4>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const showBill = document.getElementById('showBill');
        const billSection = document.getElementById('billSection');
        const books = document.querySelectorAll('.bg-white.rounded-lg.shadow-lg.overflow-hidden');
        let totalNetAmount = 0; // initialize total net amount to 0

        showBill.addEventListener('click', function (e) {
            e.preventDefault();
            billSection.classList.toggle('hidden');
        });

        document.addEventListener('click', function (e) {
            if (!billSection.contains(e.target) && e.target!== showBill) {
                billSection.classList.add('hidden');
            }
        });

        books.forEach(function (book) {
            const add = book.querySelector('.add');
            const subs = book.querySelector('.subs');
            const priceElement = book.querySelector('.price');
            const quan = book.querySelector('.quan');
            const net = book.querySelector('.net'); // get the net element for each book
            const discount = book.querySelector('.discount');

            const itemPrice = parseFloat(priceElement.textContent.replace('₹ ', '').replace(',', ''));
            let currentQuantity = parseInt(quan.textContent);

            // increase Quantity
            add.addEventListener('click', function () {
                currentQuantity++;
                quan.textContent = currentQuantity.toString().padStart(2, '0');
                updatePrice();
            });

            // decrease Quantity
            subs.addEventListener('click', function () {
                if (currentQuantity > 1) {
                    currentQuantity--;
                    quan.textContent = currentQuantity.toString().padStart(2, '0');
                    updatePrice();
                }
            });

            function updatePrice() {
                const totalPrice = currentQuantity * itemPrice;
                priceElement.textContent = '₹' + totalPrice.toFixed(2);
                const discountPercentage = parseInt(discount.textContent.match(/\d+/)[0]);
                const afterDiscount = totalPrice - (totalPrice * (discountPercentage / 100));
                net.textContent = 'Net Amount: ₹' + afterDiscount.toFixed(2);

                // update total net amount
                totalNetAmount += afterDiscount - (currentQuantity - 1) * itemPrice;
                document.querySelector('.finalNetAmount').textContent = '₹' + (totalNetAmount + 20).toFixed(2);
            }
        });
    });
</script>


<%- include('./partials/footer') %>
